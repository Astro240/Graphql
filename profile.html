<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphQL</title>
    <link rel="stylesheet" href="css/profilestyle.css">
    <style>
       

    </style>
</head>

<body>
    <button onclick="logout()">Logout</button>
    <div class="profile-container">
        <center>
        <div class="eachBand1">
			<h2><div id="userInfo"></div></h2>
		</div>
	</center>
	<div class="eachBand">
		<center>
			<svg id="graph1"></svg>
            <svg id="graph2"></svg>
		</center>
	</div>
	<div class="eachBand">
		<center>
			
		</center>
	</div>
	<div class="eachBand">
		<center>
			
		</center>
	</div>
    </div>

    <script defer>
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchProfile();
        });
    
        async function fetchProfile() {
            const token = localStorage.getItem('jwt');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
    
            try {
                const response = await fetch('https://learn.reboot01.com/api/graphql-engine/v1/graphql', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: `
                        {
                            user {
                                id
                                login
                            }
                            transaction {
                                id
                                type
                                amount
                                objectId
                                userId
                                createdAt
                                path
                            }
                            progress {
                                id
                                userId
                                objectId
                                grade
                                createdAt
                                updatedAt
                                path
                            }
                            result {
                                id
                                objectId
                                userId
                                grade
                                type
                                createdAt
                                updatedAt
                                path
                            }
                            object {
                                id
                                name
                                type
                                attrs
                            }
                        }
                        `
                    })
                });
    
                const result = await response.json();
                // console.log(result.data);
                const userInfo = result.data.user;
                if (!userInfo.length) {
                    window.location.href = 'index.html';
                    return;
                }
                var sum =0;
                for(var i = 0; i <result.data.transaction.length;i++){
                    if(result.data.transaction[i].type === "xp" && result.data.transaction[i].path.includes("piscine")){
                    sum += parseInt(result.data.transaction[i].amount)/1000;
                    }
                    console.log(result.data.transaction[i]);
                }
                console.log(sum)
                document.getElementById('userInfo').textContent = `Welcome, ${userInfo[0].login}!`;
                // Call functions to draw your SVG graphs here
                drawGraphs(userInfo);
            } catch (error) {
                console.error('Error fetching profile:', error);
                // Handle error (optional)
            }
        }
    
        function drawGraphs(userInfo) {
            const svg1 = document.getElementById('graph1');
            const svg2 = document.getElementById('graph2');
            // Sample SVG graph generation code
            // svg1.innerHTML = `<circle cx="50" cy="50" r="40" stroke="black" stroke-width="3" fill="red" />`;
            // svg2.innerHTML = `<rect width="300" height="100" style="fill:blue;" />`;
        }
    
        function logout() {
            localStorage.removeItem('jwt');
            window.location.href = 'index.html';
        }
    </script>
</body>

</html>