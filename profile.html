<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphQL</title>
    <link rel="stylesheet" href="css/profilestyle.css">
    <style>


    </style>
</head>

<body>
    <button onclick="logout()">Logout</button>
    <div class="profile-container">
        <center>
            <div class="eachBand1">
                <h2>
                    <div id="userInfo"></div>
                </h2>

            </div>
        </center>
        <div class="eachBand">
            <center>
                <h2>Experience</h2>
                <h4><span id="moduleExp"></span></h4>
                <h4><span id="jsExp"></span></h4>
                <h4><span id="goExp"></span></h4>
                <hr>
                <h3>Audits Ratio</h3>
                <span id="graph1"></span><span id="audit1" style="padding-left: 10px;"></span><br><br>
                <span id="graph2"></span><span id="audit2" style="padding-left: 10px;"></span>
                <h3 id="audits"></h3>
            </center>
        </div>
        <div class="eachBand">
            <center>

            </center>
        </div>
        <div class="eachBand">
            <center>

            </center>
        </div>
    </div>

    <script defer>
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchProfile();
        });

        async function fetchProfile() {
            const token = localStorage.getItem('jwt');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch('https://learn.reboot01.com/api/graphql-engine/v1/graphql', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: `
                        {
                            user {
                                id
                                login
                                auditRatio
                                totalUp
                                totalDown
                            }
                            transaction {
                                id
                                type
                                amount
                                objectId
                                userId
                                createdAt
                                path
                            }
                            transaction_aggregate(
                                where: {
                                _and: [
                                    { type: { _eq: "xp" } },
                                    { path: { _like: "/bahrain/bh-module/%" } }
                                    { path: { _nlike: "/bahrain/bh-module/piscine-js/%"} }
                                ]
                                }
                            ) {
                                aggregate {
                                    sum {
                                        amount
                                    }
                                }
                            }
                            js:transaction_aggregate(
                                where: {
                                _and: [
                                    { type: { _eq: "xp" } },
                                    { path: { _like: "/bahrain/bh-module/piscine-js/%" } }
                                ]
                                }
                            ) {
                                aggregate {
                                    sum {
                                        amount
                                    }
                                }
                            }
                                go:transaction_aggregate(
                                where: {
                                _and: [
                                    { type: { _eq: "xp" } },
                                    { path: { _like: "/bahrain/bh-piscine/%" } }
                                ]
                                }
                            ) {
                                aggregate {
                                    sum {
                                        amount
                                    }
                                }
                            }       
                            progress {
                                id
                                userId
                                objectId
                                grade
                                createdAt
                                updatedAt
                                path
                            }
                            result {
                                id
                                objectId
                                userId
                                grade
                                type
                                createdAt
                                updatedAt
                                path
                            }
                            object {
                                id
                                name
                                type
                                attrs
                            }
                        }
                        `
                    })
                });

                const result = await response.json();
                const data = result.data;
                const userInfo = result.data.user;
                if (!userInfo.length) {
                    window.location.href = 'index.html';
                    return;
                }

                document.getElementById('userInfo').textContent = `Welcome, ${userInfo[0].login}!`;
                document.getElementById('audits').textContent = userInfo[0].auditRatio.toFixed(1); 
                if (data.transaction_aggregate.aggregate.sum.amount != null) {
                    document.getElementById('moduleExp').textContent = "Module - " + (data.transaction_aggregate.aggregate.sum.amount / 1000).toFixed(0) + "KB";
                }
                if (data.js.aggregate.sum.amount != null) {
                    document.getElementById('jsExp').textContent = "JS Piscine - " + (data.js.aggregate.sum.amount / 1000).toFixed(0) + "KB";
                }
                if (data.go.aggregate.sum.amount != null) {
                    document.getElementById('goExp').textContent = "Go Piscine - " + (data.go.aggregate.sum.amount / 1000).toFixed(0) + "KB";
                }
                var upAudit = userInfo[0].totalUp / 1000;
                var downAudit = userInfo[0].totalDown / 1000;
                drawGraphs(userInfo, upAudit, downAudit);
                var tfUp = false;
                var tfDown = false;
                if (upAudit >= 1000) {
                    upAudit /= 1000;
                    tfUp = true;
                }
                if (downAudit >= 1000) {
                    downAudit /= 1000;
                    tfDown = true;
                }
                if (tfUp) {
                    document.getElementById('audit1').textContent = upAudit.toFixed(1) + " MB";
                } else {
                    document.getElementById('audit1').textContent = upAudit.toFixed(0) + " KB";
                }
                if (tfDown) {
                    document.getElementById('audit2').textContent = downAudit.toFixed(1) + " MB";
                } else {
                    document.getElementById('audit2').textContent = downAudit.toFixed(0) + " KB";

                }
            } catch (error) {
                console.error('Error fetching profile:', error);
                // Handle error (optional)
            }
        }

        function drawGraphs(userInfo, auditUp, auditDown) {
            const svg1 = document.getElementById('graph1');
            const svg2 = document.getElementById('graph2');
            // Sample SVG graph generation code
            if (auditUp > auditDown) {
                var test = auditDown / auditUp;
                test = 300 * test;
                svg1.innerHTML = `<svg height="10" width="300" xmlns="http://www.w3.org/2000/svg" style="border: 1px solid white;border-radius:5px"><line x1="0" y1="10" x2="300" y2="10" style="stroke:cyan;stroke-width:200;"/></svg>`;
                svg2.innerHTML = `<svg height="10" width="300" xmlns="http://www.w3.org/2000/svg" style="border: 1px solid white;border-radius:5px"><line x1="0" y1="10" x2="${test}" y2="10" style="stroke:white;stroke-width:200;"/></svg>`;
            } else {
                var test = auditUp / auditDown;
                test = 300 * test;
                svg1.innerHTML = `<svg height="10" width="300" xmlns="http://www.w3.org/2000/svg" style="border: 1px solid white;border-radius:5px"><line x1="0" y1="10" x2="${test}" y2="10" style="stroke:white;stroke-width:200;"/></svg>`;
                svg2.innerHTML = `<svg height="10" width="300" xmlns="http://www.w3.org/2000/svg" style="border: 1px solid white;border-radius:5px"><line x1="0" y1="10" x2="300" y2="10" style="stroke:cyan;stroke-width:200;"/></svg>`;

            }
        }

        function logout() {
            localStorage.removeItem('jwt');
            window.location.href = 'index.html';
        }
    </script>
</body>

</html>